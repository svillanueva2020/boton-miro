<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://miro.com/app/static/sdk.1.1.js"></script>
  <script>

    const colores = {
      colorBoton: "#050b42",
      colorBotonContramedida: "#3ed730", 
      colorMetaFinal: "#fef445",
      colorSituacionIdeal : "#fac710", 
      colorSituacionActual: "#f24726",
      colorDiferencia: "#e6e6e6"
    };
    const tiposFrame = {
      tipoframe: "FRAME",
      tipoLine: "LINE"
    };

   
    var widgets = [];

    findFrameParent = (idElement)=>{
      return widgets.find(widget => widget.type == tiposFrame.tipoframe && widget.childrenIds.includes(idElement));
    }

    miro.onReady(() => {
      miro.initialize({
        extensionPoints: {
          bottomBar: {
            title: 'Boton ada',
            svgIcon: '<circle cx="12" cy="12" r="9" fill="none" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>',
            onClick: () => {
              alert('HOLA MUNDO!')
            }
          },
          toolbar: {
            title: "Bot√≥n ADA",
            librarySvgIcon:
              '<circle cx="12" cy="12" r="9" fill="blue" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>',
            toolbarSvgIcon:
              '<circle cx="12" cy="12" r="9" fill="red" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>',
            onClick: () => {
              miro.showNotification("ADA dice HOlA!");
            },
          },
        }
      });
      (async () => {
        widgets = await miro.board.widgets.get();
        console.log("Widgets", widgets);
      })();

      async function handleSelectionUpdated(event) {
        let widgetsHijos = [];
        let widgetSeleccionado;
        console.log("El boton que activo el evento", event)
        if (event.data[0] && event.data[0].id) {
          widgetSeleccionado = widgets.find(widget => widget.id === event.data[0].id);
          console.log("El widget Seleccionado ", widgetSeleccionado)

          if (widgetSeleccionado && widgetSeleccionado.style && widgetSeleccionado.style.borderColor == colores.colorBoton) {
            console.log("el evento es", event);
            let frame = widgets.find(widget => widget.type == tiposFrame.tipoframe && widget.childrenIds.includes(event.data[0].id));
            if (frame) {
              frame.childrenIds.forEach(idChildren => {
                let widgetHijo = widgets.find(widget => widget.id === idChildren);
                widgetsHijos.push(widgetHijo);
              });
              let lineaProblema = widgets.find(widget => widget.type == tiposFrame.tipoLine && widget.endWidgetId == event.data[0].id);
              if(lineaProblema){
                let widgetReferencia = widgets.find(x => x.id == lineaProblema.startWidgetId);
                let frameReferencia = findFrameParent(widgetReferencia.id);
                if(frameReferencia){

                }
              }
              let widgetActualizar = [];
              if (lineaProblema) {
                widgetActualizar = widgetsHijos.find(widget => widget.id == lineaProblema.endWidgetId);
              }
              console.log("Linea encontrada", lineaProblema);
              console.log("widgets hijos encontrados", widgetsHijos);
              console.log("widgets A actualizar", widgetActualizar);
            }
          }

          if (widgetSeleccionado && widgetSeleccionado.style && widgetSeleccionado.style.borderColor == colores.colorBotonContramedida) {
            console.log("Ingreso por el boton de contramedida", event);
          }

        }
      }
      miro.addListener('SELECTION_UPDATED', handleSelectionUpdated);
    });



  </script>
</head>

<body>
  <h1>aplicacion miro</h1>
  <img src="robot-corto.svg" />
</body>

</html>